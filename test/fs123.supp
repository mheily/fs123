# Usage:  valgrind --tool=??? --suppressions=<this_file> mount.fs123 
#  suppresses complaints that we're pretty sure aren't actually
#  errors, or aren't under our control.
{
   emergency_exception_handler
   # May eventually be fixed in gcc7.  See:
   #  https://gcc.gnu.org/bugzilla/show_bug.cgi?id=65434#c9
   #  https://gcc.gnu.org/ml/gcc-patches/2016-12/msg01158.html
   Memcheck:Leak
   fun:malloc
   fun:_GLOBAL__sub_I_eh_alloc.cc
   fun:__libc_csu_init
   fun:(below main)
}

{
   gperftools-2.4-tcmallocguard
   Memcheck:Free
   fun:_ZdaPv
   fun:_ZN13TCMallocGuardC1Ev
...
   fun:_GLOBAL__sub_I___malloc_hook
   fun:__libc_csu_init
   fun:(below main)
}

# Icc generates *lots* of complaints.  There may well be something
# wrong.  Even if we suppress these, we get lots of "conditional jump
# or mmove depends on uninitialized values", which suggests that Intel
# has done something too-clever-by-half.
#{
#  icc_problem_in_strlen
#   Memcheck:Addr8
#   fun:__intel_sse2_strlen
#}
#
#{
#  icc_problem_strlen_2
#   Memcheck:Cond
#   fun:__intel_sse2_strlen
#}


# For now (Jan 2018), it's easier to suppress the libc-freeres with a
# supp than to run valgrind with --run-libc-freeres=yes and deal with
# the spurious leaks.  Future mileage may vary :-(.
{
   could_also_be_handled_with_--run-libc-freeres=yes
   Memcheck:Free
   fun:free
   fun:__libc_freeres
   fun:_vgnU_freeres
   fun:__run_exit_handlers
   fun:exit
   fun:(below main)
}

# Dec 2020 - valgrind on alpine with libmusl reports on two
# leaks.  I suspect these are false positives.  But even
# if not, I'm not going to worry about 4k of leakage.
#==9526== HEAP SUMMARY:
#==9526==     in use at exit: 85,707 bytes in 84 blocks
#==9526==   total heap usage: 295,797 allocs, 295,713 frees, 423,986,568 bytes allocated
#==9526== 
#==9526== 1,040 (520 direct, 520 indirect) bytes in 1 blocks are definitely lost in loss record 40 of 43
#==9526==    at 0x48A1633: calloc (vg_replace_malloc.c:761)
#==9526==    by 0x401C928: __cxa_atexit (in /lib/ld-musl-x86_64.so.1)
#==9526== 
#==9526== 3,472 bytes in 1 blocks are possibly lost in loss record 41 of 43
#==9526==    at 0x48A1633: calloc (vg_replace_malloc.c:761)
#==9526==    by 0x4059CBA: __dls3 (in /lib/ld-musl-x86_64.so.1)
#==9526==    by 0x3C4D6AF7C149B0DA: ???
#==9526==    by 0x2F632F706D742F6E: ???
#==9526==    by 0x756F6D2F6E696272: ???
#==9526==    by 0x33323173662E746D: ???
#==9526==    by 0x365F36387800376F: ???

{
  musl_atexit
  Memcheck:Leak
  fun:calloc
  fun:__cxa_atexit
}

{
   musl_dsl3
   Memcheck:Leak
   fun:calloc
   fun:__dls3
   ...
}

{
   # see comments in core123/elastic_threadpool.hpp
   LWG_issue_3343_workaround
   Memcheck:Leak
   match-leak-kinds: definite
   fun:LWGissue3343
}
